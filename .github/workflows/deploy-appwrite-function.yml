name: Deploy Backend to Appwrite Function

# =============================================================================
# Appwrite Function Deployment Workflow
# =============================================================================
#
# Deploys FastAPI backend as an Appwrite Function with custom domain (api.sfplib.com)
#
# DEPLOYMENT STRATEGY:
# - Python 3.12 runtime
# - Serverless execution
# - Auto-scaling
# - Custom domain: api.sfplib.com
# - Environment variables configured in Appwrite Console
# - requirements.txt generated dynamically from pyproject.toml (Poetry 2.x compatible)
#
# This runs independently from Sites deployment
# Frontend calls backend via /api/* rewrites to api.sfplib.com

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-appwrite-function.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  FUNCTION_NAME: 'backend-api'
  PYTHON_VERSION: '3.12'

jobs:
  deploy-function:
    name: Deploy Backend Function
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://api.sfplib.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Appwrite CLI
        run: |
          npm install -g appwrite-cli
          appwrite --version

      - name: Login to Appwrite
        env:
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT || secrets.APPWRITE_ENDPOINT_URL }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
        run: |
          appwrite client \
            --endpoint "$APPWRITE_ENDPOINT" \
            --project-id "$APPWRITE_PROJECT_ID" \
            --key "$APPWRITE_API_KEY"

      - name: Prepare backend for deployment
        working-directory: backend
        run: |
          echo "üì¶ Preparing backend for Appwrite Function deployment..."

          # Ensure pyproject.toml is present
          if [ ! -f "pyproject.toml" ]; then
            echo "‚ùå ERROR: pyproject.toml not found"
            exit 1
          fi

          # Install Poetry
          echo "Installing Poetry..."
          pip install poetry

          # Install poetry-plugin-export (required for Poetry 2.x)
          echo "Installing poetry-plugin-export for Poetry 2.x compatibility..."
          poetry self add poetry-plugin-export

          # Generate requirements.txt from Poetry
          echo "Generating requirements.txt from pyproject.toml..."
          poetry export -f requirements.txt --output requirements.txt --without-hashes --without dev

          echo "‚úÖ Backend prepared"
          echo "requirements.txt size: $(wc -l < requirements.txt) lines"
          ls -la

      - name: Deploy Function
        working-directory: backend
        env:
          APPWRITE_FUNCTION_ID: ${{ secrets.APPWRITE_FUNCTION_ID }}
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT || secrets.APPWRITE_ENDPOINT_URL }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
        run: |
          echo "üöÄ Deploying backend to Appwrite Functions..."

          # Deploy function using Appwrite CLI
          appwrite functions createDeployment \
            --functionId "$APPWRITE_FUNCTION_ID" \
            --entrypoint "app/main.py" \
            --code "." \
            --activate true

          echo "‚úÖ Function deployed successfully"

      - name: Update function configuration
        env:
          APPWRITE_FUNCTION_ID: ${{ secrets.APPWRITE_FUNCTION_ID }}
        run: |
          echo "‚öôÔ∏è Updating function configuration..."

          # Update function settings
          appwrite functions update \
            --functionId "$APPWRITE_FUNCTION_ID" \
            --name "$FUNCTION_NAME" \
            --runtime "python-3.12" \
            --execute "any" \
            --timeout 30 \
            --enabled true \
            --logging true

          echo "‚úÖ Configuration updated"

      - name: Verify custom domain
        run: |
          echo "üåê Verifying custom domain configuration..."
          echo "Expected: https://api.sfplib.com"
          echo ""
          echo "‚ö†Ô∏è  Manual step required:"
          echo "   1. Go to Appwrite Console > Functions > $FUNCTION_NAME > Settings"
          echo "   2. Set custom domain: api.sfplib.com"
          echo "   3. Verify DNS CNAME record points to Appwrite"

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üöÄ Appwrite Function Deployment Summary

          **Status**: ‚úÖ Success
          **Environment**: ${{ github.event.inputs.environment || 'production' }}
          **Function**: $FUNCTION_NAME
          **Runtime**: Python ${{ env.PYTHON_VERSION }}
          **Branch**: \`${{ github.ref_name }}\`
          **Commit**: \`${{ github.sha }}\`

          ### Deployment Info
          - **Function URL**: https://api.sfplib.com
          - **Fallback URL**: Check Appwrite Console for auto-generated URL
          - **Execution**: Public (any)
          - **Timeout**: 30 seconds
          - **Logging**: Enabled

          ### Environment Variables
          Configure these in Appwrite Console > Functions > $FUNCTION_NAME > Settings > Environment Variables:

          \`\`\`bash
          DEPLOYMENT_MODE=appwrite
          APPWRITE_ENDPOINT=https://nyc.cloud.appwrite.io/v1
          APPWRITE_PROJECT_ID=${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_DATABASE_ID=sfpliberate
          APPWRITE_COLLECTION_ID=sfp_modules
          APPWRITE_BUCKET_ID=sfp_eeprom_data
          LOG_LEVEL=INFO
          \`\`\`

          ### Next Steps
          1. ‚úÖ Verify function is running in Appwrite Console
          2. ‚ö†Ô∏è Configure custom domain api.sfplib.com (if not done)
          3. ‚úÖ Test API endpoints: https://api.sfplib.com/api/v1/modules
          4. ‚úÖ Deploy frontend (Sites) to complete stack

          ### Testing
          \`\`\`bash
          # Test health endpoint
          curl https://api.sfplib.com/api/v1/modules

          # Test with authentication
          curl -H "X-Appwrite-Project: ${{ secrets.APPWRITE_PROJECT_ID }}" \\
               https://api.sfplib.com/api/v1/modules
          \`\`\`

          EOF

  # Notify on failure
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [deploy-function]
    if: failure()
    steps:
      - name: Create failure summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ‚ùå Function Deployment Failed

          **Branch**: \`${{ github.ref_name }}\`
          **Commit**: \`${{ github.sha }}\`

          ### Troubleshooting
          1. Check deployment logs above
          2. Verify GitHub Secrets:
             - \`APPWRITE_ENDPOINT\` (or \`APPWRITE_ENDPOINT_URL\`)
             - \`APPWRITE_PROJECT_ID\`
             - \`APPWRITE_API_KEY\`
             - \`APPWRITE_FUNCTION_ID\` (create in Console first)
          3. Verify function exists in Appwrite Console
          4. Check Poetry dependencies in backend/pyproject.toml
          5. Ensure Python 3.12 runtime is available
          6. If poetry export fails, verify poetry.lock is up-to-date

          ### Create Function Manually
          If function doesn't exist:
          1. Go to Appwrite Console > Functions > Create Function
          2. Name: backend-api
          3. Runtime: Python 3.12
          4. Save the Function ID as \`APPWRITE_FUNCTION_ID\` secret
          5. Re-run this workflow

          EOF
