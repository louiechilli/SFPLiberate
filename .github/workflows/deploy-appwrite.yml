name: Deploy to Appwrite Cloud

# =============================================================================
# MAINTAINER-ONLY: Appwrite Sites Deployment Workflow
# =============================================================================
# 
# This workflow is for MAINTAINER USE ONLY to deploy the public hosted instance.
# Self-hosters should use docker-compose.yml instead.
#
# DEPLOYMENT METHODS:
# 1. Git Auto-Deploy (RECOMMENDED for production): Push to main triggers automatic deployment
#    - Configure in Appwrite Console: Sites > Settings > Git Repository > Connect to main branch
#    - Appwrite auto-injects environment variables (APPWRITE_SITE_API_ENDPOINT, APPWRITE_SITE_PROJECT_ID)
#    - Control features via environment variables in Appwrite Console
#    - No GitHub Actions needed - Appwrite handles build and deployment
#    - See docs/APPWRITE_SITES_DEPLOYMENT.md for full setup
# 
# 2. Manual Deployment (THIS WORKFLOW): Upload tar.gz via Sites API
#    - Useful for testing before enabling Git auto-deploy
#    - Useful for deploying from non-main branches during development
#    - Requires manual build and package steps
#    - Uses GitHub secrets for Appwrite credentials
# 
# 3. CLI Deployment: Use `appwrite push sites` command (local development)
#
# FEATURE FLAG DEPLOYMENT STRATEGY:
# - All code lives on main branch
# - Features controlled by APPWRITE_SITE_ENABLE_* environment variables
# - Deploy with flags OFF, then enable via Appwrite Console when ready
# - No separate staging branches needed
#
# Only runs for feature/appwrite branches or manual triggers
# Production uses Git Auto-Deploy from main branch

on:
  push:
    branches:
      - 'feature/appwrite*'
      - 'feat/appwrite*'
      - main  # Allow manual workflow from main for testing
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  NODE_VERSION: '22'
  FRONTEND_DIR: frontend

jobs:
  # Validation job - informational only
  validate:
    name: Validate Branch
    runs-on: ubuntu-latest
    steps:
      - name: Check branch
        run: |
          echo "üìã Deploying from branch: ${{ github.ref }}"
          echo ""
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "‚ÑπÔ∏è  NOTE: Manual deployment from main branch"
            echo "‚ÑπÔ∏è  Consider using Git Auto-Deploy for production:"
            echo "   1. Connect site to GitHub in Appwrite Console"
            echo "   2. Set production branch to 'main'"
            echo "   3. Push to main for automatic deployments"
            echo ""
            echo "‚ö†Ô∏è  This manual workflow is best for testing or non-production scenarios"
          else
            echo "‚úÖ Feature branch deployment - manual workflow is appropriate"
          fi
          echo ""
          echo "‚úÖ Validation passed"

  # Build and deploy to Appwrite
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: ${{ github.event.inputs.environment || 'staging' }}
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ env.FRONTEND_DIR }}
        run: npm ci --legacy-peer-deps

      - name: Build static export for Appwrite
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          # Appwrite Configuration (auto-injected by Appwrite Sites in production)
          # For manual workflow deployment, provide these from secrets:
          APPWRITE_SITE_API_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT_URL }}
          APPWRITE_SITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          
          # Backend API URL (Appwrite Function endpoint)
          APPWRITE_SITE_API_URL: ${{ secrets.PUBLIC_API_URL || 'https://api.sfpliberate.com' }}
          
          # Feature flags (control feature visibility)
          # These should match production environment variables in Appwrite Console
          APPWRITE_SITE_ENABLE_AUTH: true
          APPWRITE_SITE_ENABLE_WEB_BLUETOOTH: true
          APPWRITE_SITE_ENABLE_BLE_PROXY: true
          APPWRITE_SITE_ENABLE_COMMUNITY_FEATURES: true
          
          # Build optimization
          NEXT_TELEMETRY_DISABLED: 1
          NODE_ENV: production
        run: |
          echo "üèóÔ∏è Building Next.js static export for Appwrite..."
          npm run build
          echo "‚úÖ Build completed successfully"

      - name: Verify build output
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          if [ ! -d "out" ]; then
            echo "‚ùå ERROR: Build output directory 'out' not found"
            exit 1
          fi
          
          echo "üì¶ Build output summary:"
          du -sh out/
          find out -type f | wc -l | xargs echo "Total files:"
          
          # Check for critical files
          critical_files=("out/index.html" "out/_next")
          for file in "${critical_files[@]}"; do
            if [ ! -e "$file" ]; then
              echo "‚ùå ERROR: Critical file/directory missing: $file"
              exit 1
            fi
          done
          
          echo "‚úÖ Build output validation passed"

      - name: Package build output
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "üì¶ Packaging build output..."
          cd out
          tar --exclude code.tar.gz -czf ../code.tar.gz .
          cd ..
          echo "‚úÖ Build packaged successfully"
          ls -lh code.tar.gz

      - name: Deploy to Appwrite Sites
        id: deploy
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          APPWRITE_ENDPOINT: ${{ secrets.APPWRITE_ENDPOINT_URL }}
          APPWRITE_PROJECT_ID: ${{ secrets.APPWRITE_PROJECT_ID }}
          APPWRITE_API_KEY: ${{ secrets.APPWRITE_API_KEY }}
          APPWRITE_SITE_ID: ${{ secrets.APPWRITE_SITE_ID }}
        run: |
          echo "ÔøΩ Deploying to Appwrite Sites..."
          
          # Install node-appwrite for API access
          npm install node-appwrite
          
          # Create deployment using Sites API
          node << 'EOF'
          const sdk = require('node-appwrite');
          const fs = require('fs');
          
          const client = new sdk.Client()
            .setEndpoint(process.env.APPWRITE_ENDPOINT)
            .setProject(process.env.APPWRITE_PROJECT_ID)
            .setKey(process.env.APPWRITE_API_KEY);
          
          const sites = new sdk.Sites(client);
          
          (async () => {
            try {
              console.log('ÔøΩ Uploading deployment...');
              
              const code = sdk.InputFile.fromPath('./code.tar.gz', 'code.tar.gz');
              
              const deployment = await sites.createDeployment({
                siteId: process.env.APPWRITE_SITE_ID,
                code: code,
                activate: true, // Activate immediately after build
              });
              
              console.log('‚úÖ Deployment created successfully');
              console.log(`Deployment ID: ${deployment.$id}`);
              console.log(`Status: ${deployment.status}`);
              
              // Write deployment URL to output
              const deployUrl = `${process.env.APPWRITE_ENDPOINT}/console/project-${process.env.APPWRITE_PROJECT_ID}/sites/site-${process.env.APPWRITE_SITE_ID}/deployment-${deployment.$id}`;
              console.log(`üåê Deployment URL: ${deployUrl}`);
              
              // Write to GitHub output
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `url=${deployUrl}\n`);
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `deployment_id=${deployment.$id}\n`);
              
            } catch (error) {
              console.error('‚ùå Deployment failed:', error.message);
              process.exit(1);
            }
          })();
          EOF

      - name: Create deployment summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## üöÄ Appwrite Deployment Summary
          
          **Status**: ‚úÖ Success
          **Environment**: ${{ github.event.inputs.environment || 'staging' }}
          **Branch**: \`${{ github.ref_name }}\`
          **Commit**: \`${{ github.sha }}\`
          **Triggered by**: ${{ github.actor }}
          
          ### Build Configuration
          - **Deployment Mode**: Appwrite (static export)
          - **Node Version**: ${{ env.NODE_VERSION }}
          - **Next.js Output**: Static HTML/CSS/JS
          - **Authentication**: Enabled (Appwrite native)
          
          ### Features Enabled
          - ‚úÖ Web Bluetooth API
          - ‚úÖ BLE Proxy Support
          - ‚úÖ Community Features
          - ‚úÖ Appwrite Authentication
          
          ### Deployment Info
          - **Appwrite Endpoint**: \`${{ secrets.APPWRITE_ENDPOINT_URL }}\`
          - **Project ID**: \`${{ secrets.APPWRITE_PROJECT_ID }}\`
          - **Deployment URL**: ${{ steps.deploy.outputs.url }}
          
          ### Next Steps
          1. Verify deployment at the URL above
          2. Test authentication flow
          3. Test BLE functionality
          4. Check API connectivity to backend
          
          EOF

  # Notify on failure
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: failure()
    steps:
      - name: Create failure summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ‚ùå Appwrite Deployment Failed
          
          **Branch**: \`${{ github.ref_name }}\`
          **Commit**: \`${{ github.sha }}\`
          **Triggered by**: ${{ github.actor }}
          
          ### Troubleshooting
          1. Check the logs above for error messages
          2. Verify GitHub Secrets are configured:
             - \`APPWRITE_API_KEY\`
             - \`APPWRITE_ENDPOINT_URL\`
             - \`APPWRITE_PROJECT_ID\`
             - \`APPWRITE_SITE_ID\` (get from Appwrite Console > Sites)
          3. Ensure you're not deploying from main branch
          4. Check Appwrite project configuration
          5. See docs/APPWRITE_DEPLOYMENT.md for detailed guide
          
          ### Alternative: Use Git Auto-Deploy
          For production, connect your site to GitHub in Appwrite Console:
          1. Go to Sites > Your Site > Settings > Git Repository
          2. Click "Connect Git" and authorize GitHub
          3. Select repository and production branch
          4. Pushes to production branch will auto-deploy
          
          EOF
