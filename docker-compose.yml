# Docker Compose file for SFPLiberate
# Compose Spec (no version field needed for v2.40+)
# https://docs.docker.com/compose/compose-file/

name: sfpliberate

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.new
      args:
        - PYTHON_VERSION=${PYTHON_VERSION:-3.14}
        - POETRY_VERSION=${POETRY_VERSION:-1.8.5}
        - BUILD_DATE=${BUILD_DATE}
        - VCS_REF=${VCS_REF}
        - VERSION=${VERSION:-dev}
      # Enable BuildKit for better caching and performance
    image: sfpliberate-backend:${VERSION:-latest}
    container_name: sfpliberate-backend

    # Restart policy
    restart: unless-stopped

    # Environment variables
    environment:
      # Deployment Mode (standalone=SQLite only for Docker deployments)
      # Note: Appwrite cloud deployment uses backend Functions, not Docker
      - DEPLOYMENT_MODE=standalone
      # SQLite configuration
      - DATABASE_FILE=/app/data/sfp_library.db
      - SUBMISSIONS_DIR=/app/data/submissions
      # Application settings
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - PYTHONUNBUFFERED=1
      - ENVIRONMENT=${ENVIRONMENT:-production}
      # ESPHome Proxy (optional)
      - ESPHOME_PROXY_MODE=${ESPHOME_PROXY_MODE:-false}

    # Volumes
    volumes:
      - backend_data:/app/data:rw
      # Bind-mount .env to allow backend to persist profile UUIDs (self-hosted)
      - ./.env:/app/.env:rw

    # Publish the API to the host so the frontend (bridge networking by default) can proxy without
    # an intermediate reverse-proxy container. Override BACKEND_HOST_PORT if needed.
    ports:
      - "${BACKEND_HOST_PORT:-8081}:80"

    # Network
    networks:
      - sfp-internal

    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

    # Health check
    healthcheck:
      test: [ "CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost/api/modules').read()" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Security options
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp
      - /app/.cache

    # Labels
    labels:
      - "com.sfpliberate.service=backend"
      - "com.sfpliberate.description=FastAPI backend for SFP module management"
      - "com.sfpliberate.version=${VERSION:-dev}"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - BUILD_DATE=${BUILD_DATE}
        - VCS_REF=${VCS_REF}
        - VERSION=${VERSION:-dev}
    image: sfpliberate-frontend:${VERSION:-latest}
    container_name: sfpliberate-frontend

    # Restart policy
    restart: unless-stopped

    # Depends on backend with health condition
    depends_on:
      backend:
        condition: service_healthy
        restart: true

    # Environment
    environment:
      - ENVIRONMENT=${ENVIRONMENT:-production}
      # Next.js rewrites target the backend via docker internal DNS by default
      - BACKEND_URL=http://backend:80
      # Note: Deployment mode is AUTO-DETECTED by frontend
      # Standalone mode when APPWRITE_SITE_* variables are absent (default here)
      - PORT=${FRONTEND_PORT:-3000}

    ports:
      - "${FRONTEND_PORT:-3000}:3000"

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.75'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M

    # Health check
    healthcheck:
      test: [ "CMD", "node", "-e", "require('http').get('http://localhost:3000/', r => process.exit(r.statusCode < 500 ? 0 : 1))" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Security options
    security_opt:
      - no-new-privileges:true
    # Disabled read_only for Next.js 16 standalone mode compatibility
    # read_only: true
    tmpfs:
      - /tmp

    # Labels
    labels:
      - "com.sfpliberate.service=frontend"
      - "com.sfpliberate.description=Next.js frontend with API proxy"
      - "com.sfpliberate.version=${VERSION:-dev}"
      - "traefik.enable=true"
      - "traefik.http.routers.sfpliberate.rule=Host(`${DOMAIN:-localhost}`)"
      - "traefik.http.routers.sfpliberate.entrypoints=websecure"
      - "traefik.http.routers.sfpliberate.tls.certresolver=letsencrypt"
      - "traefik.http.services.sfpliberate.loadbalancer.server.port=3000"

networks:
  sfp-internal:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/24
    labels:
      - "com.sfpliberate.network=internal"

volumes:
  # Named volume for backend data persistence
  # Docker manages this volume automatically - no need to create directories manually
  backend_data:
    driver: local
    labels:
      - "com.sfpliberate.volume=backend-data"
      - "com.sfpliberate.backup=true"
    # Volume is stored in Docker's volume directory (e.g., /var/lib/docker/volumes/)
    # To backup: docker run --rm -v sfpliberate_backend_data:/data -v $(pwd):/backup alpine tar czf /backup/backup.tar.gz /data
    # To restore: docker run --rm -v sfpliberate_backend_data:/data -v $(pwd):/backup alpine tar xzf /backup/backup.tar.gz
